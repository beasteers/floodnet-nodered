[
    {
        "id": "b8f9c9a92652ae8e",
        "type": "tab",
        "label": "Sensor ingestion",
        "disabled": false,
        "info": ""
    },
    {
        "id": "e3941d68335018ed",
        "type": "tab",
        "label": "Gateway ingestion",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "59b6ea3e0dab2122",
        "type": "tab",
        "label": "Weather ingestion",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e0603b84198efa0a",
        "type": "tab",
        "label": "Tidal ingestion",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "54e1edf44c387788",
        "type": "tab",
        "label": "Sensor calibration",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "101718428de70120",
        "type": "tab",
        "label": "Sensor creation",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "767ee0c79d6fcca5",
        "type": "tab",
        "label": "Sensor deploy",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e63e21ac547645de",
        "type": "tab",
        "label": "Sensor manage",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "41b751a153893032",
        "type": "tab",
        "label": "Dev",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8f7859036b247ff4",
        "type": "mqtt-broker",
        "name": "floodnet-production",
        "broker": "nam1.cloud.thethings.network",
        "port": "8883",
        "tls": "4ad802e2463acc54",
        "clientid": "",
        "autoConnect": true,
        "usetls": true,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "sessionExpiry": ""
    },
    {
        "id": "4ad802e2463acc54",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": true,
        "alpnprotocol": ""
    },
    {
        "id": "4b9a03aed4358412",
        "type": "influxdb",
        "hostname": "127.0.0.1",
        "port": "8086",
        "protocol": "http",
        "database": "database",
        "name": "",
        "usetls": false,
        "tls": "4ad802e2463acc54",
        "influxdbVersion": "2.0",
        "url": "http://influxdb:8086",
        "rejectUnauthorized": true
    },
    {
        "id": "b34078e6.e60df8",
        "type": "ui_tab",
        "z": "101718428de70120",
        "name": "Create",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "ebb68a36bf8edca2",
        "type": "ui_base",
        "theme": {
            "name": "theme-dark",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#097479",
                    "value": "#097479",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#111111",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#0eb8c0",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#555555",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#eeeeee",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#333333",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "f4b50fc6dae783b8",
        "type": "ui_group",
        "name": "Create sensor",
        "tab": "b34078e6.e60df8",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "803f2d085a7b80f8",
        "type": "ui_group",
        "name": "Deploy sensor",
        "tab": "4f7beffc6bad8cca",
        "order": 3,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "a8ccca99870fd736",
        "type": "ui_group",
        "name": "New sensor keys",
        "tab": "b34078e6.e60df8",
        "order": 3,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "b0e7be89053d38f6",
        "type": "ui_tab",
        "name": "Quality control",
        "icon": "dashboard",
        "order": 2,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "4f7beffc6bad8cca",
        "type": "ui_tab",
        "name": "Deploy",
        "icon": "dashboard",
        "order": 3,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "afaab3096b157a9b",
        "type": "ui_group",
        "name": "Quality control",
        "tab": "b0e7be89053d38f6",
        "order": 4,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "15cc5b5e815472cf",
        "type": "ui_group",
        "name": "Rev geocode",
        "tab": "4f7beffc6bad8cca",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "a8bf5499468b4017",
        "type": "ui_group",
        "name": "Locate",
        "tab": "4f7beffc6bad8cca",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "b0207c7b4d5ca6a1",
        "type": "ui_group",
        "name": "Manage",
        "tab": "5cbcc75ca3ef874c",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "5cbcc75ca3ef874c",
        "type": "ui_tab",
        "name": "Manage",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "d5ace342b009a2b0",
        "type": "mqtt in",
        "z": "b8f9c9a92652ae8e",
        "name": "FloodNet - floodnet_flood_sensor",
        "topic": "#",
        "qos": "0",
        "datatype": "json",
        "broker": "8f7859036b247ff4",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 60,
        "wires": [
            [
                "d4dd1fb1.22cae"
            ]
        ]
    },
    {
        "id": "d4dd1fb1.22cae",
        "type": "function",
        "z": "b8f9c9a92652ae8e",
        "name": "TTN V3 JSON processor",
        "func": "var uplink_info = msg.payload['uplink_message'];\n\nif (typeof uplink_info == undefined)\n    return undefined;\n\nif (msg.payload['join_accept'])\n    return undefined;\n\nvar dev_info = msg.payload['end_device_ids'];\nvar tags = {\n            dev_id: dev_info['device_id'],\n            app_name: dev_info['application_ids']['application_id'],\n            dev_addr: dev_info['dev_addr'],\n            dev_eui: dev_info['dev_eui'],\n            network: 'ttn',\n            bw_hz: uplink_info['settings']['data_rate']['lora']['bandwidth'],\n            sf: uplink_info['settings']['data_rate']['lora']['spreading_factor'],\n            coding_rate: uplink_info['settings']['coding_rate'],\n            f_port: uplink_info['f_port']\n        };\n\nvar fields = {\n            lora_freq_hz: parseInt(uplink_info['settings']['frequency']),\n            f_cnt: uplink_info['f_cnt'],\n            airtime_s: parseFloat(uplink_info['consumed_airtime'].replace('s', ''))\n            \n        };\n\n// Sort gateway data by RSSI strength\ngw_object = uplink_info['rx_metadata'];\ngw_object_sorted = gw_object.sort(function(a, b) {\n    return parseFloat(b.rssi) - parseFloat(a.rssi);\n});\n\nconst gw_keys = Object.keys(gw_object_sorted);\n\nvar gw_cnt = 0;\nfor (var gw_key of gw_keys) {\n    if (gw_object_sorted[gw_key].hasOwnProperty('packet_broker'))\n        continue;\n    gw_cnt += 1;\n    tags['gw_' + gw_cnt + '_id'] = gw_object_sorted[gw_key]['gateway_ids']['gateway_id'];\n    fields['gw_' + gw_cnt + '_rssi_dbm'] = gw_object_sorted[gw_key]['rssi'];\n    fields['gw_' + gw_cnt + '_snr_db'] = gw_object_sorted[gw_key]['snr'];\n    \n}\n\nraw_payload = uplink_info['frm_payload'];\n\nif (!raw_payload){\n    msg.app_type = undefined;\n    return msg;\n}else{\n    msg.app_type = dev_info['device_id'].slice(0, 2);\n}\n\nvar binary_string = Buffer.from(raw_payload, \"base64\").toString('hex').match(/.{1,2}/g);\nvar len = binary_string.length;\nvar b = new Uint8Array(len);\nfor (var i = 0; i < len; i++) {\n    b[i] = parseInt(binary_string[i], 16);\n}\n\nvar errorFlag = b[0];\n\nif (errorFlag == 255) {\n    // Payload is Sensor cfg update\n    /*\n    CFG update uplink Format:\n    | Error Flag  |   sensor_sleep   |    sensor_agg     |   sensor_meas_delta     | sensor_reading_count   |    sensor_state   |    fw_ver       |\n    |    255 (FF) |     2 bytes      |      1 byte       |          2 bytes        |          1 byte        |        1 byte     |    6 bytes      |\n    \n    Sensor State:\n    |  Start  |   Stop  |  Reset  |\n    |   's'   |   'x'   |   'r'   |\n    \n    */\n    \n    // Duty cycle\n    var sensor_sleep = (b[2]<< 8) | b[1];\n    tags['sensor_sleep_s'] = sensor_sleep;\n    \n    // Sensor Mode\n    var sensor_agg = b[3];\n    tags['sensor_agg'] = sensor_agg;\n    \n    // Sensor Sampling Rate\n    var sensor_meas_delta = (b[5] << 8) | b[4];\n    tags['sensor_meas_delta_ms'] = sensor_meas_delta;\n    \n    // Sensor number of readings per measurement\n    var sensor_reading_count = b[6];\n    tags['sensor_reading_count'] = sensor_reading_count;\n    \n    // Sensor State\n    var sensor_state = b[7].toString();\n    \n    if (sensor_state == \"115\"){\n      sensor_state = \"Sensing\";\n    } else if (sensor_state == \"120\"){\n      sensor_state = \"CFG Update\";\n    } else if (sensor_state == \"114\"){\n      sensor_state = \"Reset\";\n    }\n    tags['sensor_state'] = sensor_state;\n    \n    // Firmware Version\n    let major = b[8].toString();\n    let minor = b[9].toString();\n    let patch = b[10].toString();\n    let v = \"v\";\n    let dot = \".\";\n    let fw_ver = v.concat(major,dot,minor,dot,patch);\n    \n    tags['fw_ver'] = fw_ver;\n\n\n}\n\nreturn { payload: \n    [\n        fields,\n        tags,\n        b\n    ], 'app_type': msg['app_type'],\n    'ts': Date.parse(uplink_info['received_at'])\n};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 60,
        "wires": [
            [
                "9426b45005b4832d"
            ]
        ]
    },
    {
        "id": "4f19e58b65fd28a1",
        "type": "function",
        "z": "b8f9c9a92652ae8e",
        "name": "Payload decoder - flood sensor",
        "func": "var fields = msg.payload[0];\nvar tags = msg.payload[1];\nb = msg.payload[2];\n\nvar len = b.length;\n\nvar errorFlag = b[0];\n\nif (errorFlag != 255) {\n\n    // Regular Payload\n    \n    // Converting Error Flag bits\n    tags['error_flag'] = errorFlag % 2;\n    \n    // battery\n    battery = (b[2] << 8) | b[1]; // battery in centi Volts\n    battery = battery / 1000; // Convert to Volts\n    fields['batt_v'] = battery;\n    \n    // distance\n    distance = (b[4] << 8) | b[3];\n    fields['dist_mm'] = distance;\n    \n    // depth\n    var night_median = global.get(tags.dev_id + '.night_median');\n    if (night_median !== undefined){\n        var depth = -distance + night_median;\n        fields['depth_mm'] = depth;\n    }\n    \n    if (len > 5){\n        // temperature\n        var temperature = (b[6] & 0x80 ? 0xFFFF<<16 : 0) | b[6]<<8 | b[5];\n        temperature = temperature/100;\n        fields['temp_c'] = temperature;\n        \n        // pressure\n        var pressure = (((b[10]<<24) | (b[9]<<16)) | (b[8]<<8)) | b[7];\n        pressure = pressure/100;\n        fields['pres_mb'] = pressure;\n        \n        // altitude\n        var altitude = (b[12] << 8) | b[11];\n        altitude = altitude/100;\n        fields['alt_m'] = altitude;\n        \n        // humidity\n        var humidity = (b[14] << 8) | b[13];\n        humidity = humidity/100;\n        fields['humid_percen'] = humidity;\n    }\n}\n\nmsg.payload = [\n    {\n        measurement: 'flood-sensor',\n        fields,\n        tags,\n        timestamp: msg['ts']\n    }\n    ];\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 280,
        "wires": [
            [
                "5bb5b33dc3b86e38"
            ]
        ]
    },
    {
        "id": "9426b45005b4832d",
        "type": "switch",
        "z": "b8f9c9a92652ae8e",
        "name": "",
        "property": "app_type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "fs",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "rg",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 90,
        "y": 240,
        "wires": [
            [
                "4f19e58b65fd28a1",
                "6268df4c0a325049"
            ],
            [
                "c76d93addfcecc14"
            ],
            [
                "a4c825bdcb08158d"
            ],
            [
                "cc9083c494de6e5a"
            ]
        ]
    },
    {
        "id": "a4c825bdcb08158d",
        "type": "function",
        "z": "b8f9c9a92652ae8e",
        "name": "Payload decoder - gw rain gauge",
        "func": "var fields = msg.payload[0];\nvar tags = msg.payload[1];\nvar b = msg.payload[2];\n\nvar len = b.length;\n\nvar errorFlag = b[0];\n\nif (errorFlag < 253) {\n\n    // Regular Payload\n    var acc = (b[0]|(b[1]<<8)|(b[2]<<16)|(b[3]<<32))/100;\n    var eventAcc = (b[4]|(b[5]<<8)|(b[6]<<16)|(b[7]<<32))/100;\n    var totalAcc = (b[8]|(b[9]<<8)|(b[10]<<16)|(b[11]<<32))/100;\n    var rInt = (b[12]|(b[13]<<8)|(b[14]<<16)|(b[15]<<32))/100;\n    var units;\n    \n    fields['acc_mm'] = acc;\n    fields['event_acc_mm'] = eventAcc;\n    fields['total_acc_mm'] = totalAcc;\n    fields['r_int_hr_mm'] = rInt;\n      let unit = String.fromCharCode(b[16]);\n      if (unit == 'm'){\n        units = 'mm';\n      } else {\n        units = 'in';\n      }\n      tags['acc_unit'] = units;\n}\n\nmsg.payload = [\n    {\n        measurement: 'gateway-rain-gauge',\n        fields,\n        tags,\n        timestamp: msg['ts']\n    }\n    ];\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 360,
        "wires": [
            [
                "59c384dba7c30e0d"
            ]
        ]
    },
    {
        "id": "cc9083c494de6e5a",
        "type": "debug",
        "z": "b8f9c9a92652ae8e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 480,
        "wires": []
    },
    {
        "id": "6268df4c0a325049",
        "type": "switch",
        "z": "b8f9c9a92652ae8e",
        "name": "",
        "property": "payload[2]",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 350,
        "y": 200,
        "wires": [
            [
                "513fbc9cc32e5fc3"
            ]
        ]
    },
    {
        "id": "59c384dba7c30e0d",
        "type": "influxdb batch",
        "z": "b8f9c9a92652ae8e",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Sensor data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 830,
        "y": 320,
        "wires": []
    },
    {
        "id": "513fbc9cc32e5fc3",
        "type": "debug",
        "z": "b8f9c9a92652ae8e",
        "name": "Flood sensor out",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 550,
        "y": 200,
        "wires": []
    },
    {
        "id": "5bb5b33dc3b86e38",
        "type": "function",
        "z": "b8f9c9a92652ae8e",
        "name": "Depth filter",
        "func": "var depth = msg.payload[0].fields.depth_mm;\n\nif (depth <= 10 || depth > 4500){\n    depth = 0;\n}\n\nmsg.payload[0].fields.depth_mm = depth;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 260,
        "wires": [
            [
                "59c384dba7c30e0d"
            ]
        ]
    },
    {
        "id": "c76d93addfcecc14",
        "type": "function",
        "z": "b8f9c9a92652ae8e",
        "name": "Payload decoder - tidal sensor",
        "func": "var fields = msg.payload[0];\nvar tags = msg.payload[1];\nb = msg.payload[2];\n\nvar len = b.length;\n\nvar errorFlag = b[0];\n\nif (errorFlag < 253) {\n\n    // Regular Payload\n    \n    // Converting Error Flag bits\n    tags['error_flag'] = errorFlag % 2;\n    \n    // battery\n    battery = (b[2] << 8) | b[1]; // battery in centi Volts\n    battery = battery / 1000; // Convert to Volts\n    fields['batt_v'] = battery;\n    \n    // distance\n    distance = (b[4] << 8) | b[3];\n    fields['dist_mm'] = distance;\n    \n    // depth\n    // TODO: use global var to store manually inserted MLLW value using NR GUI\n    // var night_median = global.get(tags.dev_id + '.night_median');\n    // if (night_median !== undefined){\n    //     var depth = -distance + night_median;\n    //     fields['depth_mm'] = depth;\n    // }\n    \n    if (len > 5){\n        // temperature\n        var temperature = (b[6] & 0x80 ? 0xFFFF<<16 : 0) | b[6]<<8 | b[5];\n        temperature = temperature/100;\n        fields['temp_c'] = temperature;\n        \n        // pressure\n        var pressure = (((b[10]<<24) | (b[9]<<16)) | (b[8]<<8)) | b[7];\n        pressure = pressure/100;\n        fields['pres_mb'] = pressure;\n        \n        // altitude\n        var altitude = (b[12] << 8) | b[11];\n        altitude = altitude/100;\n        fields['alt_m'] = altitude;\n        \n        // humidity\n        var humidity = (b[14] << 8) | b[13];\n        humidity = humidity/100;\n        fields['humid_percen'] = humidity;\n    }\n}\n\nmsg.payload = [\n    {\n        measurement: 'tidal-sensor',\n        fields,\n        tags,\n        timestamp: msg['ts']\n    }\n    ];\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 320,
        "wires": [
            [
                "59c384dba7c30e0d"
            ]
        ]
    },
    {
        "id": "a333bbcff1929612",
        "type": "inject",
        "z": "e3941d68335018ed",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "date",
        "x": 110,
        "y": 40,
        "wires": [
            [
                "d08956275a10d893"
            ]
        ]
    },
    {
        "id": "6f0b53f20d15d5d8",
        "type": "http request",
        "z": "e3941d68335018ed",
        "name": "GW ID GET",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://eu1.cloud.thethings.network/api/v3/users/{{{tti_user}}}/gateways",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 450,
        "y": 40,
        "wires": [
            [
                "cb2e8564e10f832a"
            ]
        ]
    },
    {
        "id": "d08956275a10d893",
        "type": "credentials",
        "z": "e3941d68335018ed",
        "name": "TTI token store",
        "props": [
            {
                "value": "tti_user",
                "type": "msg"
            },
            {
                "value": "headers.Authorization",
                "type": "msg"
            }
        ],
        "x": 280,
        "y": 40,
        "wires": [
            [
                "6f0b53f20d15d5d8"
            ]
        ]
    },
    {
        "id": "cb2e8564e10f832a",
        "type": "change",
        "z": "e3941d68335018ed",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload.gateways",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 660,
        "y": 40,
        "wires": [
            [
                "c53d8aedbedb0c01"
            ]
        ]
    },
    {
        "id": "c53d8aedbedb0c01",
        "type": "split",
        "z": "e3941d68335018ed",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 110,
        "y": 140,
        "wires": [
            [
                "173f3a7cea0eb1df"
            ]
        ]
    },
    {
        "id": "d55cefb55950509e",
        "type": "http request",
        "z": "e3941d68335018ed",
        "name": "GW stat GET",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/gs/gateways/{{{payload.ids.gateway_id}}}/connection/stats",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 670,
        "y": 140,
        "wires": [
            [
                "bdb138bb6fe7fc89"
            ]
        ]
    },
    {
        "id": "f5f13934eb8ab41d",
        "type": "credentials",
        "z": "e3941d68335018ed",
        "name": "TTI token store",
        "props": [
            {
                "value": "tti_user",
                "type": "msg"
            },
            {
                "value": "headers.Authorization",
                "type": "msg"
            }
        ],
        "x": 480,
        "y": 140,
        "wires": [
            [
                "d55cefb55950509e"
            ]
        ]
    },
    {
        "id": "173f3a7cea0eb1df",
        "type": "change",
        "z": "e3941d68335018ed",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "gateway_id",
                "pt": "msg",
                "to": "payload.ids.gateway_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 280,
        "y": 140,
        "wires": [
            [
                "f5f13934eb8ab41d"
            ]
        ]
    },
    {
        "id": "bdb138bb6fe7fc89",
        "type": "function",
        "z": "e3941d68335018ed",
        "name": "",
        "func": "if (msg.statusCode == 404){\n    return undefined\n}\n\nvar gateway_id = msg.gateway_id;\nvar last_uplink_dt = Date.parse(msg.payload.last_uplink_received_at);\nvar uplink_cnt = parseInt(msg.payload.uplink_count);\nvar downlink_cnt = parseInt(msg.payload.downlink_count);\n\nvar status_object = msg.payload.last_status;\n\nvar lat;\nvar lng;\nvar altitude;\n\nnode.warn(status_object);\nif (typeof status_object.antenna_locations !== 'undefined'){\n    lat = status_object.antenna_locations[0].latitude || undefined;\n    lng = status_object.antenna_locations[0].longitude || undefined;\n    altitude = status_object.antenna_locations[0].altitude || undefined;\n}\n\nvar ip_addr;\n\nif (typeof status_object.ip !== 'undefined'){\n    ip_addr = status_object.ip[0] || undefined;\n}\n\nvar uplink_ok = status_object.metrics.rxok;\nvar uplink_recv = status_object.metrics.rxin;\nvar ack_recv = status_object.metrics.ackr;\nvar downlink_ok = status_object.metrics.txok;\nvar downlink_recv = status_object.metrics.txin;\n\nvar ts = Date.parse(status_object.time);\n\nvar fields = {\n            uplink_ok: uplink_ok || undefined,\n            uplink_recv: uplink_recv || undefined,\n            ack_recv: ack_recv || undefined,\n            downlink_ok: downlink_ok || undefined,\n            downlink_recv: downlink_recv || undefined,\n            last_uplink_dt: last_uplink_dt || undefined,\n            uplink_cnt: uplink_cnt || undefined,\n            downlink_cnt: downlink_cnt || undefined\n            \n        };\n        \nvar tags = {\n            gateway_id: gateway_id,\n            lat: lat,\n            lng: lng,\n            ip_addr: ip_addr || undefined,\n            // TODO: add human readable name to GW creation process scripts\n            gateway_name: undefined\n        };\n        \nmsg.payload = [\n    {\n        measurement: 'gateway',\n        fields,\n        tags,\n        timestamp: ts\n    }\n    ];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 220,
        "wires": [
            [
                "050c9b632ed81f5d"
            ]
        ]
    },
    {
        "id": "050c9b632ed81f5d",
        "type": "influxdb batch",
        "z": "e3941d68335018ed",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "GW data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 300,
        "y": 220,
        "wires": []
    },
    {
        "id": "62f132ed4b7660a9",
        "type": "http request",
        "z": "59b6ea3e0dab2122",
        "name": "MN request",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://api.nysmesonet.org/data/dynserv/coned/5min/nyc/{{{timerange}}}?{{{payload}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 150,
        "y": 100,
        "wires": [
            [
                "b84c28e164baf1e6"
            ]
        ]
    },
    {
        "id": "4f87538ceb946c0d",
        "type": "inject",
        "z": "59b6ea3e0dab2122",
        "name": "Inject MN station URLs",
        "props": [
            {
                "p": "timerange",
                "v": "$join(\t   [\t       $fromMillis($millis() - 240000),\t       $fromMillis($millis())\t   ],\t   '/'\t)",
                "vt": "jsonata"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "10",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "$join(\t   [\t       'variables[]=tair@degC',\t       'variables[]=tslo@degC',\t       'variables[]=relh@percent',\t       'variables[]=precip:incremental@mm',\t       'variables[]=precip@mm',\t       'variables[]=precip_local@mm',\t       'variables[]=precip_total@mm',\t       'variables[]=precip_max_intensity@mm/min',\t       'variables[]=winds_sonic@m/s',\t       'variables[]=srad@W/m^2',\t       'variables[]=pres@millibars',\t       'variables[]=snow_depth@mm',\t       'variables[]=lat@degrees',\t       'variables[]=lon@degrees'\t   ],\t   '&'\t)",
        "payloadType": "jsonata",
        "x": 150,
        "y": 20,
        "wires": [
            [
                "62f132ed4b7660a9"
            ]
        ]
    },
    {
        "id": "bf77b6cbe5bb5efb",
        "type": "csv",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "sep": ",",
        "hdrin": true,
        "hdrout": "none",
        "multi": "mult",
        "ret": "\\n",
        "temp": "",
        "skip": "0",
        "strings": true,
        "include_empty_strings": "",
        "include_null_values": "",
        "x": 270,
        "y": 220,
        "wires": [
            [
                "c76e21c56c558be6"
            ]
        ]
    },
    {
        "id": "b84c28e164baf1e6",
        "type": "switch",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 210,
        "y": 160,
        "wires": [
            [
                "bf77b6cbe5bb5efb"
            ]
        ]
    },
    {
        "id": "c76e21c56c558be6",
        "type": "function",
        "z": "59b6ea3e0dab2122",
        "name": "Check for empty",
        "func": "cnt = 0;\n\nfor (const station of msg.payload){\n    cnt += Object.keys(station).length;\n}\n\nif (cnt == msg.payload.length * 4)\n    return '';\nelse\n    return msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 20,
        "wires": [
            [
                "3f60b54328ff9718"
            ]
        ]
    },
    {
        "id": "3f60b54328ff9718",
        "type": "switch",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 410,
        "y": 80,
        "wires": [
            [
                "ed9c3a5a7b9aedf2"
            ]
        ]
    },
    {
        "id": "742bda0e4b0972e6",
        "type": "inject",
        "z": "59b6ea3e0dab2122",
        "name": "Inject NWS station URLs",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[\t   'https://api.weather.gov/stations/KJFK/observations/latest',\t   'https://api.weather.gov/stations/KLGA/observations/latest',\t   'https://api.weather.gov/stations/KNYC/observations/latest'\t]",
        "payloadType": "jsonata",
        "x": 150,
        "y": 280,
        "wires": [
            [
                "567665bec1f6ee11"
            ]
        ]
    },
    {
        "id": "567665bec1f6ee11",
        "type": "split",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": true,
        "addname": "",
        "x": 170,
        "y": 340,
        "wires": [
            [
                "49ad4015de5d0710"
            ]
        ]
    },
    {
        "id": "bba0e1b1684e109b",
        "type": "http request",
        "z": "59b6ea3e0dab2122",
        "name": "NWS request",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 290,
        "y": 460,
        "wires": [
            [
                "4c120bcceeb78769"
            ]
        ]
    },
    {
        "id": "49ad4015de5d0710",
        "type": "change",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "url",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 400,
        "wires": [
            [
                "bba0e1b1684e109b"
            ]
        ]
    },
    {
        "id": "4c120bcceeb78769",
        "type": "switch",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "property": "payload['properties']['rawMessage']",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 390,
        "y": 280,
        "wires": [
            [
                "e5a534afcfdc4833"
            ]
        ]
    },
    {
        "id": "4871d24c8081c6c1",
        "type": "influxdb batch",
        "z": "59b6ea3e0dab2122",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "NWS weather data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 710,
        "y": 280,
        "wires": []
    },
    {
        "id": "e5a534afcfdc4833",
        "type": "function",
        "z": "59b6ea3e0dab2122",
        "name": "Setup NWS payload",
        "func": "var data_payload = msg.payload['properties'];\nvar station_id = data_payload['rawMessage'].slice(0,4).trim().toLowerCase();\nvar sensor_id = 'nws-' + station_id;\nvar location_info = msg.payload['geometry'];\nvar ts = Date.parse(data_payload['timestamp']);\n// Quality control checks\n// https://madis.ncep.noaa.gov/madis_sfc_qc_notes.shtml\n\nvar fields = {\n            // timestamp: ts,\n            temp_c: data_payload['temperature']['value'],\n            wind_dir_deg: data_payload['windDirection']['value'],\n            wind_speed_kmh: data_payload['windSpeed']['value'],\n            visibility: data_payload['visibility']['value'],\n            baro_pres_pa: data_payload['barometricPressure']['value'],\n            precip_last_hour_mm: data_payload['precipitationLastHour']['value'] * 1000,\n            relhumid_percent: +data_payload['relativeHumidity']['value'],\n            windchill_c: +data_payload['windChill']['value']\n        };\n        \nvar tags = {\n            weather_group: 'nws',\n            sensor_id: sensor_id,\n            lat: location_info['coordinates'][1],\n            lng: location_info['coordinates'][0],\n            sensor_types: 'temp,humid,precip,pres,wind',\n            sensor_name: 'NWS ' + station_id.slice(1,4).toUpperCase() + ' Weather station (' + station_id.toUpperCase() + ')'\n        };\n        \nmsg.payload = [\n    {\n        measurement: 'weather',\n        fields,\n        tags,\n        timestamp: ts\n    }\n    ];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 340,
        "wires": [
            [
                "4871d24c8081c6c1"
            ]
        ]
    },
    {
        "id": "9f175b1da3175ea9",
        "type": "function",
        "z": "59b6ea3e0dab2122",
        "name": "Setup MN payload",
        "func": "var data_payload = msg.payload;\nvar station_id = data_payload['station'];\nvar sensor_id = 'nyc-micronet-' + station_id.toLowerCase();\n// var location_info = msg.payload['geometry'];\nvar ts = Date.parse(data_payload['datetime']);\n\nvar fields = {\n            // timestamp: ts,\n            temp_c: data_payload['temp_2m [degC]'] || undefined,\n            temp_slow_c: data_payload['tslo [degC]'] || undefined,\n            wind_speed_kmh: (data_payload['avg_wind_speed_sonic [m/s]'] * 3.6) || undefined,\n            baro_pres_pa: (data_payload['station_pressure [millibars]'] * 100) || undefined,\n            precip_increm_mm: data_payload['precip_incremental [mm]'] || undefined,\n            max_precip_last_5min_mm_per_min: data_payload['precip_max_intensity [mm/min]'] || undefined,\n            relhumid_percent: data_payload['relative_humidity [percent]'] || undefined,\n            wind_dir_deg: data_payload['wind_direction_sonic [degrees]'] || undefined,\n            solar_insol_wm2: data_payload['solar_insolation [W/m^2]'] || undefined,\n            snow_depth_mm: data_payload['snow_depth [mm]'] || undefined\n        };\n        \nvar tags = {\n            weather_group: 'micronet',\n            sensor_id: sensor_id,\n            lat: data_payload['lat [degrees]'],\n            lng: data_payload['lon [degrees]'],\n            sensor_types: 'temp,humid,precip,pres,wind,solar',\n            sensor_name: 'NYC Micronet weather station (' + station_id + ')'\n        };\n        \nmsg.payload = [\n    {\n        measurement: 'weather',\n        fields,\n        tags,\n        timestamp: ts\n    }\n    ];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 200,
        "wires": [
            [
                "51f38eac8def364f"
            ]
        ]
    },
    {
        "id": "ed9c3a5a7b9aedf2",
        "type": "split",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 450,
        "y": 140,
        "wires": [
            [
                "9f175b1da3175ea9"
            ]
        ]
    },
    {
        "id": "51f38eac8def364f",
        "type": "influxdb batch",
        "z": "59b6ea3e0dab2122",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "NYC Micronet weather data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 700,
        "y": 40,
        "wires": []
    },
    {
        "id": "4c44e3abc4fcd1eb",
        "type": "http request",
        "z": "59b6ea3e0dab2122",
        "name": "Open Weather API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.openweathermap.org/data/2.5/onecall?lat={{{lat_lon.0}}}&lon={{{lat_lon.1}}}&exclude=hourly,daily&appid={{{appid}}}&units=metric",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 370,
        "y": 640,
        "wires": [
            [
                "f9137c59125d3c0d"
            ]
        ]
    },
    {
        "id": "c9f27f5d47a10a45",
        "type": "inject",
        "z": "59b6ea3e0dab2122",
        "name": "Inject OWM locations",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "3480",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[\t   [40.680092,-74.014416],\t   [40.676195,-73.986974],\t   [40.598504,-73.970988],\t   [40.575299,-73.996754],\t   [40.653567,-73.923218],\t   [40.657421,-73.830684],\t   [40.611045,-73.821752],\t   [40.714464,-73.749413],\t   [40.683750,-73.890956],\t   [40.769089,-73.925311],\t   [40.774001,-73.823847],\t   [40.594925,-74.089129],\t   [40.533894,-74.197005],\t   [40.613171,-74.159901],\t   [40.716077,-74.007504],\t   [40.724654,-73.975840],\t   [40.802544,-73.948427],\t   [40.865397,-73.923453],\t   [40.820639,-73.913116],\t   [40.829500,-73.859615],\t   [40.882832,-73.851669],\t   [40.846075,-73.787256],\t   [40.775942,-73.872940]\t]",
        "payloadType": "jsonata",
        "x": 140,
        "y": 520,
        "wires": [
            [
                "410c903622f6c8e2"
            ]
        ]
    },
    {
        "id": "e8f6d2b22d197f13",
        "type": "credentials",
        "z": "59b6ea3e0dab2122",
        "name": "OWAPI and G key store",
        "props": [
            {
                "value": "appid",
                "type": "msg"
            },
            {
                "value": "gapikey",
                "type": "msg"
            }
        ],
        "x": 210,
        "y": 760,
        "wires": [
            [
                "51effb339ea4f74e"
            ]
        ]
    },
    {
        "id": "0193d0cc4010e60f",
        "type": "function",
        "z": "59b6ea3e0dab2122",
        "name": "OWM setup payload",
        "func": "var weather_payload = msg.owm;\nvar revgeocode_payload = msg.revgeocode;\nvar meas_array = [];\nvar forecast_mins = 60;\nvar sensor_id = 'owm-' + revgeocode_payload.osm_id;\nvar sensor_name = revgeocode_payload.address.neighbourhood + ' - openweathermap.org (' + sensor_id + ')';\n\nvar rain_amnt,snow_amnt = null;\n\nif (weather_payload.current.rain){\n    rain_amnt = weather_payload.current.rain['1h'];\n}\n\nif (weather_payload.current.snow){\n    snow_amnt = weather_payload.current.snow['1h'];\n}\n\n\nvar cur_weather = {\n   measurement: 'weather',\n      fields: {\n        temp_c: weather_payload.current['temp'],\n        baro_pres_pa: weather_payload.current['pressure'] * 1000,\n        relhumid_percent: weather_payload.current['humidity'],\n        cloud_percent: weather_payload.current['clouds'],\n        wind_speed_kmh: weather_payload.current['wind_speed'] * 3.6,\n        wind_dir_deg: weather_payload.current['wind_deg'],\n        precip_last_hour_mm: rain_amnt || undefined,\n        snow_last_hour_mm: snow_amnt || undefined\n      },\n      tags:{\n        weather_group: 'open_weather_map_forecast',\n        sensor_id: sensor_id,\n        lat: weather_payload.lat,\n        lng: weather_payload.lon,\n        sensor_types: 'temp,humid,precip,pres,wind,solar',\n        sensor_name: sensor_name,\n        sensor_address_zip: revgeocode_payload.address.postcode,\n        sensor_address_borough: revgeocode_payload.address.suburb,\n        sensor_address_state: revgeocode_payload.address.state,\n        sensor_address_country: revgeocode_payload.address.country,\n        sensor_address_house_number: revgeocode_payload.address.house_number,\n        sensor_address_street: revgeocode_payload.address.road,\n        sensor_address_neighbourhood: revgeocode_payload.address.neighbourhood\n      },\n      timestamp: weather_payload.current['dt'] * 1000\n};\n\nmeas_array.push(cur_weather);\n\nif (weather_payload.minutely){\n    for (var i = 0; i < forecast_mins; i++) {\n        var min_item = weather_payload.minutely[i];\n        var min_entry = {\n          measurement: 'weather',\n          fields: {\n            precip_forecast_last_min_mm: min_item['precipitation']\n          },\n          tags:{\n            weather_group: 'open_weather_map_forecast',\n            sensor_id: sensor_id,\n            lat: weather_payload.lat,\n            lng: weather_payload.lon,\n            sensor_types: 'temp,humid,precip,pres,wind,solar',\n            sensor_name: sensor_name,\n            sensor_address_zip: revgeocode_payload.address.postcode,\n            sensor_address_borough: revgeocode_payload.address.suburb,\n            sensor_address_state: revgeocode_payload.address.state,\n            sensor_address_country: revgeocode_payload.address.country,\n            sensor_address_house_number: revgeocode_payload.address.house_number,\n            sensor_address_street: revgeocode_payload.address.road,\n            sensor_address_neighbourhood: revgeocode_payload.address.neighbourhood\n          },\n          timestamp: min_item['dt'] * 1000\n        };\n        meas_array.push(min_entry);\n    }\n}\n\nmsg.payload = meas_array;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 680,
        "wires": [
            [
                "2ea12566e4a0ddc7"
            ]
        ]
    },
    {
        "id": "f03ba767c129f69b",
        "type": "http request",
        "z": "59b6ea3e0dab2122",
        "name": "Rev geocode",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://nominatim.openstreetmap.org/reverse?format=json&lat={{{lat_lon.0}}}&lon={{{lat_lon.1}}}&zoom=18&addressdetails=1",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 610,
        "y": 580,
        "wires": [
            [
                "e45925d81c5ddfda"
            ]
        ]
    },
    {
        "id": "410c903622f6c8e2",
        "type": "split",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 130,
        "y": 640,
        "wires": [
            [
                "8aa86b86eaddc827"
            ]
        ]
    },
    {
        "id": "8aa86b86eaddc827",
        "type": "delay",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "50",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 180,
        "y": 700,
        "wires": [
            [
                "e8f6d2b22d197f13"
            ]
        ]
    },
    {
        "id": "20fd99b272aaccde",
        "type": "change",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "owm",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 760,
        "wires": [
            [
                "f03ba767c129f69b"
            ]
        ]
    },
    {
        "id": "e45925d81c5ddfda",
        "type": "change",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "revgeocode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 640,
        "wires": [
            [
                "0193d0cc4010e60f"
            ]
        ]
    },
    {
        "id": "51effb339ea4f74e",
        "type": "change",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "lat_lon",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 580,
        "wires": [
            [
                "4c44e3abc4fcd1eb"
            ]
        ]
    },
    {
        "id": "2ea12566e4a0ddc7",
        "type": "influxdb batch",
        "z": "59b6ea3e0dab2122",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "OWM weather data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 1010,
        "y": 640,
        "wires": []
    },
    {
        "id": "f9137c59125d3c0d",
        "type": "switch",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "property": "payload.current",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 430,
        "y": 700,
        "wires": [
            [
                "20fd99b272aaccde"
            ]
        ]
    },
    {
        "id": "567882fde5fd37ac",
        "type": "inject",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 230,
        "y": 880,
        "wires": [
            [
                "1a58d11f48c449fb"
            ]
        ]
    },
    {
        "id": "561e89fef3638cc8",
        "type": "http request",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://maps.googleapis.com/maps/api/geocode/json?address=1600+Amphitheatre+Parkway,+Mountain+View,+CA&key={{{gapikey}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 520,
        "y": 900,
        "wires": [
            [
                "65eb469bb43fed61"
            ]
        ]
    },
    {
        "id": "65eb469bb43fed61",
        "type": "debug",
        "z": "59b6ea3e0dab2122",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 780,
        "y": 900,
        "wires": []
    },
    {
        "id": "1a58d11f48c449fb",
        "type": "credentials",
        "z": "59b6ea3e0dab2122",
        "name": "OWAPI and G key store",
        "props": [
            {
                "value": "appid",
                "type": "msg"
            },
            {
                "value": "gapikey",
                "type": "msg"
            }
        ],
        "x": 330,
        "y": 820,
        "wires": [
            [
                "561e89fef3638cc8"
            ]
        ]
    },
    {
        "id": "9637d78579cb1b2b",
        "type": "inject",
        "z": "e0603b84198efa0a",
        "name": "Inject station_ids",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "180",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[\t    8518750,\t    8516945\t]",
        "payloadType": "jsonata",
        "x": 130,
        "y": 40,
        "wires": [
            [
                "690cfc0fd6894019"
            ]
        ]
    },
    {
        "id": "478c541fff4fedfa",
        "type": "http request",
        "z": "e0603b84198efa0a",
        "name": "NOAA tide API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=water_level&application=NOS.COOPS.TAC.WL&date=latest&datum=MHHW&station={{{payload}}}&time_zone=gmt&units=metric&format=json",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 320,
        "y": 160,
        "wires": [
            [
                "71134cb878e2e45b"
            ]
        ]
    },
    {
        "id": "690cfc0fd6894019",
        "type": "split",
        "z": "e0603b84198efa0a",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 230,
        "y": 100,
        "wires": [
            [
                "478c541fff4fedfa"
            ]
        ]
    },
    {
        "id": "71134cb878e2e45b",
        "type": "function",
        "z": "e0603b84198efa0a",
        "name": "",
        "func": "var data_payload = msg.payload.data[0];\nvar station_id = msg.payload.metadata.id;\nvar sensor_id = 'noaa-tidal-' + station_id;\nvar sensor_name = msg.payload.metadata.name + ' (' + station_id + ')';\nvar lat = parseFloat(msg.payload.metadata.lat);\nvar lng = parseFloat(msg.payload.metadata.lon);\nvar ts = Date.parse(data_payload.t + ' GMT');\n\nvar fields = {\n            height_mm: parseFloat(data_payload.v) * 1000 || undefined,\n            sigma_mm: parseFloat(data_payload.s) || undefined\n        };\n        \nvar tags = {\n            sensor_id: sensor_id,\n            lat: lat,\n            lng: lng,\n            sensor_types: 'tide',\n            sensor_name: sensor_name\n        };\n        \nmsg.payload = [\n    {\n        measurement: 'tide',\n        fields,\n        tags,\n        timestamp: ts\n    }\n    ];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 220,
        "wires": [
            [
                "4d2ae3bb71a480eb"
            ]
        ]
    },
    {
        "id": "4d2ae3bb71a480eb",
        "type": "influxdb batch",
        "z": "e0603b84198efa0a",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Tidal data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 560,
        "y": 300,
        "wires": []
    },
    {
        "id": "bb63f3f9f599785f",
        "type": "inject",
        "z": "e0603b84198efa0a",
        "name": "Inject station_ids",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[\t   \"01302020\",\t   \"01311875\",\t   \"01376562\",\t   \"01311850\",\t   \"01376520\",\t   \"01376515\",\t   \"01302027\",\t   \"01302025\",\t   \"01311145\",\t   \"01311143\",\t   \"01310740\",\t   \"01310521\",\t   \"01302250\"\t]",
        "payloadType": "jsonata",
        "x": 150,
        "y": 380,
        "wires": [
            [
                "0dca1a125cfcdcdd"
            ]
        ]
    },
    {
        "id": "0dca1a125cfcdcdd",
        "type": "split",
        "z": "e0603b84198efa0a",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 270,
        "y": 440,
        "wires": [
            [
                "ae046715aba47672"
            ]
        ]
    },
    {
        "id": "ae046715aba47672",
        "type": "http request",
        "z": "e0603b84198efa0a",
        "name": "USGS tide API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://waterwatch.usgs.gov/webservices/realtime?format=json&site={{{payload}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 380,
        "y": 500,
        "wires": [
            [
                "7cf54d59c09487d0"
            ]
        ]
    },
    {
        "id": "7cf54d59c09487d0",
        "type": "function",
        "z": "e0603b84198efa0a",
        "name": "",
        "func": "if (msg.payload.sites == undefined){\n    return undefined;\n}\n\nvar data_payload = msg.payload.sites[0];\nvar station_id = data_payload.site_no;\nvar sensor_id = 'usgs-tidal-' + station_id;\nvar sensor_name = data_payload.station_nm;\nvar lat = data_payload.dec_lat_va;\nvar lng = data_payload.dec_long_va;\nvar ts = Date.parse(data_payload.stage_dt + ' ' + data_payload.tz_cd);\n\nvar fields = {\n            stage_mm: data_payload.stage * 304.8 || undefined\n        };\n        \nvar tags = {\n            sensor_id: sensor_id,\n            lat: lat,\n            lng: lng,\n            sensor_types: 'tide',\n            sensor_name: sensor_name\n        };\n        \nmsg.payload = [\n    {\n        measurement: 'tide',\n        fields,\n        tags,\n        timestamp: ts\n    }\n    ];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 560,
        "wires": [
            [
                "44fac76d4e932ad9"
            ]
        ]
    },
    {
        "id": "44fac76d4e932ad9",
        "type": "influxdb batch",
        "z": "e0603b84198efa0a",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Tidal data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 740,
        "y": 560,
        "wires": []
    },
    {
        "id": "97a92550bb51b952",
        "type": "inject",
        "z": "54e1edf44c387788",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "15 05 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[\t   'floodnet-test',\t   'floodnet-lab',\t   'floodnet-live'\t]",
        "payloadType": "jsonata",
        "x": 70,
        "y": 80,
        "wires": [
            [
                "0d93778db11fa758"
            ]
        ]
    },
    {
        "id": "bb90fef6fb25b7ee",
        "type": "influxdb in",
        "z": "54e1edf44c387788",
        "influxdb": "4b9a03aed4358412",
        "name": "",
        "query": "",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "floodnet",
        "x": 350,
        "y": 260,
        "wires": [
            [
                "c9d6973e721d7130"
            ]
        ]
    },
    {
        "id": "93083f815ba539af",
        "type": "function",
        "z": "54e1edf44c387788",
        "name": "Create query",
        "func": "var bucket_name = msg.payload;\nvar lookback_days = 3;\n\nvar std_limit = 5.0;\n\nvar tz_offset = new Date().getTimezoneOffset() / 60;\n\nvar st_hour = 22;\nvar en_hour = 5;\n\nvar st_ts = new Date();\nst_ts.setDate(st_ts.getDate() - lookback_days);\nst_ts.setHours(st_hour);\nst_ts.setMinutes(0);\nst_ts.setSeconds(0);\nst_ts.setMilliseconds(0);\n\nvar st_hour_utc = st_ts.getHours() + tz_offset;\nif (st_hour_utc > 24){\n    st_hour_utc -= 24;\n}\n\nvar en_ts = new Date();\nen_ts.setHours(en_hour);\nen_ts.setMinutes(0);\nen_ts.setSeconds(0);\nen_ts.setMilliseconds(0);\n\nvar en_hour_utc = en_ts.getHours() + tz_offset;\nif (en_hour_utc > 24){\n    en_hour_utc -= 24;\n}\n\nvar meas_name = 'flood-sensor';\nvar app_name = 'nyu-production';\nvar field_name = 'dist_mm';\n\nvar agg_str = 'mean';\n\nvar query = \n`\nimport \"date\"\ndata = from(bucket: \"${bucket_name}\")\n  |> range(start: ${st_ts.getTime() / 1000}, stop:${en_ts.getTime() / 1000})\n  |> filter(fn: (r) => r._measurement == \"${meas_name}\")\n  |> filter(fn: (r) => r.app_name == \"${app_name}\")\n  |> filter(fn: (r) => r._field == \"${field_name}\")\n  |> filter(fn: (r) => {\n    hour = date.hour(t: r._time)\n    return hour >= ${st_hour_utc} and hour < ${en_hour_utc}\n  })\n  |> keep(columns: [\"_value\", \"dev_id\"])\n  |> group(columns: [\"dev_id\"])\n\nstd_var = data |> stddev()\nmed_var = data |> ${agg_str}()\njoin(tables: {stddev: std_var, ${agg_str}: med_var}, on: [\"dev_id\"])\n|> rename(columns: {_value_mean: \"${agg_str}\", _value_stddev: \"stddev\"})\n|> filter(fn: (r) =>\n    r.stddev < ${std_limit}\n  )\n`\nmsg.query = query;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 210,
        "y": 200,
        "wires": [
            [
                "bb90fef6fb25b7ee"
            ]
        ]
    },
    {
        "id": "4257d78af3302b76",
        "type": "debug",
        "z": "54e1edf44c387788",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 790,
        "y": 320,
        "wires": []
    },
    {
        "id": "c9d6973e721d7130",
        "type": "function",
        "z": "54e1edf44c387788",
        "name": "Create median insert",
        "func": "var meas_array = [];\n\nfor (let i = 0; i < msg.payload.length; i++) {\n    var info = msg.payload[i]\n    if (info.stddev < 5.0){\n        var global_var_name = info.dev_id + '.night_median';\n        global.set(global_var_name, info.mean);\n        msg.median = info.mean;\n        var influx_entry = {\n            measurement: 'flood-sensor',\n            fields: {\n                night_median_mm: info.mean\n            },\n            tags:{\n                sensor_id: info.dev_id\n            },\n            timestamp: new Date().getTime()\n        };\n        meas_array.push(influx_entry);\n    }\n}\n\nmsg.payload = meas_array;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 320,
        "wires": [
            [
                "45af59cd0c241688",
                "4257d78af3302b76"
            ]
        ]
    },
    {
        "id": "45af59cd0c241688",
        "type": "influxdb batch",
        "z": "54e1edf44c387788",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Median insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-lab",
        "x": 660,
        "y": 380,
        "wires": []
    },
    {
        "id": "0d93778db11fa758",
        "type": "split",
        "z": "54e1edf44c387788",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 110,
        "y": 140,
        "wires": [
            [
                "93083f815ba539af"
            ]
        ]
    },
    {
        "id": "3e6cb67dffee43dc",
        "type": "http request",
        "z": "101718428de70120",
        "name": "Get app devs",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://eu1.cloud.thethings.network/api/v3/applications/{{{payload}}}/devices",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 940,
        "y": 640,
        "wires": [
            [
                "7554e0bbfc352912"
            ]
        ]
    },
    {
        "id": "b55ed6954feb034d",
        "type": "credentials",
        "z": "101718428de70120",
        "name": "TTI token store",
        "props": [
            {
                "value": "tti_user",
                "type": "msg"
            },
            {
                "value": "headers.Authorization",
                "type": "msg"
            }
        ],
        "x": 760,
        "y": 640,
        "wires": [
            [
                "3e6cb67dffee43dc"
            ]
        ]
    },
    {
        "id": "a5776f2bed3d2d5c",
        "type": "split",
        "z": "101718428de70120",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 450,
        "y": 640,
        "wires": [
            [
                "da430a9b7a874f15"
            ]
        ]
    },
    {
        "id": "7554e0bbfc352912",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "if (msg.statusCode != 200){\n    msg.complete = 1;\n    msg.parts = [];\n    msg.payload = msg.parts;\n    return msg;\n}\n\nvar dev_array = [];\n\nfor (let i = 0; i < msg.payload.end_devices.length; i++) {\n  var dev_id = msg.payload.end_devices[i].ids.device_id;\n  if (dev_id.includes('fs-') || \n        dev_id.includes('rg-') ||\n        dev_id.includes('ts-') ||\n        dev_id.includes('fn-')\n        ){\n    dev_array.push(dev_id);\n  }\n}\n\nmsg.dev_array = dev_array;\nmsg.parts = dev_array;\nmsg.payload = msg.parts;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 700,
        "wires": [
            [
                "f0b60bd24b8d1ea9"
            ]
        ]
    },
    {
        "id": "a8e0c13e05e832d6",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "Sensor type",
        "label": "Sensor type:",
        "tooltip": "",
        "place": "Sensor type",
        "group": "f4b50fc6dae783b8",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Flood sensor",
                "value": "fs",
                "type": "str"
            },
            {
                "label": "Rain gauge",
                "value": "rg",
                "type": "str"
            },
            {
                "label": "Tidal sensor",
                "value": "ts",
                "type": "str"
            },
            {
                "label": "Old convention",
                "value": "fn",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 670,
        "y": 700,
        "wires": [
            [
                "a4d8da4788898304"
            ]
        ]
    },
    {
        "id": "a4d8da4788898304",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "var dev_array = flow.get(\"dev_array\");\nvar dev_type = msg.payload;\n\nconst filt_devs = dev_array.filter((dev) => {\n  return dev.includes(dev_type);\n}).sort();\n\nlet free_dev_array = [];\nlet free_count = 0;\nfor (let i = 1; i < 99999; i++) {\n  var s = i+\"\";\n  while (s.length < 5) s = \"0\" + s;\n  var target_dev_id = dev_type + '-' + s;\n  if (filt_devs.includes(target_dev_id)) continue;\n  free_dev_array.push(target_dev_id);\n  free_count += 1;\n  if (free_count > 100){\n      break;\n  }\n}\n\nmsg.options = free_dev_array;\nmsg.payload = free_dev_array[0];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 700,
        "wires": [
            [
                "afeeb47286efbd0f"
            ]
        ]
    },
    {
        "id": "513076c43ec8af13",
        "type": "ui_ui_control",
        "z": "101718428de70120",
        "name": "On load",
        "events": "connect",
        "x": 140,
        "y": 640,
        "wires": [
            [
                "95d43463751127ad"
            ]
        ]
    },
    {
        "id": "bd83d31ea5a6ab88",
        "type": "change",
        "z": "101718428de70120",
        "name": "set to fs",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "fs",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 700,
        "wires": [
            [
                "a8e0c13e05e832d6",
                "7eea9fd8404f4ea2"
            ]
        ]
    },
    {
        "id": "95d43463751127ad",
        "type": "change",
        "z": "101718428de70120",
        "name": "app_names",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    \"floodnet-test\",\t    \"nyu-production\",\t    \"fnapp-10000\",\t    \"complete\"\t    \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 640,
        "wires": [
            [
                "a5776f2bed3d2d5c"
            ]
        ]
    },
    {
        "id": "f0b60bd24b8d1ea9",
        "type": "join",
        "z": "101718428de70120",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "num",
        "reduceFixup": "",
        "x": 270,
        "y": 700,
        "wires": [
            [
                "35b7b1db898fbdcd"
            ]
        ]
    },
    {
        "id": "cf8c1e604a7e8a11",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Network:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "The Things Network",
                "value": "ttn",
                "type": "str"
            },
            {
                "label": "Helium",
                "value": "helium",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 360,
        "y": 240,
        "wires": [
            [
                "e13c2b115ae6c405"
            ]
        ]
    },
    {
        "id": "afeeb47286efbd0f",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Sensor ID:",
        "tooltip": "",
        "place": "Select option",
        "group": "f4b50fc6dae783b8",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 970,
        "y": 700,
        "wires": [
            [
                "dc0d1cf9b769ae5c"
            ]
        ]
    },
    {
        "id": "74087393325035f7",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Sensor types:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": true,
        "options": [
            {
                "label": "Range",
                "value": "range",
                "type": "str"
            },
            {
                "label": "Temperature",
                "value": "temp",
                "type": "str"
            },
            {
                "label": "Humidity",
                "value": "humid",
                "type": "str"
            },
            {
                "label": "Precipitation",
                "value": "precip",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 380,
        "y": 300,
        "wires": [
            [
                "39fc015814128640"
            ]
        ]
    },
    {
        "id": "0c9700d67847344a",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Built by:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Praneeth",
                "value": "psv",
                "type": "str"
            },
            {
                "label": "Ricardo",
                "value": "rtc",
                "type": "str"
            },
            {
                "label": "Charlie",
                "value": "cm",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 360,
        "y": 360,
        "wires": [
            [
                "07c0c2992678b86e"
            ]
        ]
    },
    {
        "id": "3ab57096287dda8f",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Design version:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "AB02 micro",
                "value": "nyu_mk2",
                "type": "str"
            },
            {
                "label": "Feather",
                "value": "nyu_mk1",
                "type": "str"
            },
            {
                "label": "Feather tubed",
                "value": "cuny_mk1",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 380,
        "y": 420,
        "wires": [
            [
                "505a67c8f2179f38"
            ]
        ]
    },
    {
        "id": "c90888da15b9b25a",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Housing:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Micro",
                "value": "micro",
                "type": "str"
            },
            {
                "label": "Louvered",
                "value": "louvered",
                "type": "str"
            },
            {
                "label": "QILIPSU junction box",
                "value": "junc_box",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 360,
        "y": 480,
        "wires": [
            [
                "89ab5415ab2c45e1"
            ]
        ]
    },
    {
        "id": "2d52a60e5029a81a",
        "type": "ui_text_input",
        "z": "101718428de70120",
        "name": "",
        "label": "QC height 1:",
        "tooltip": "",
        "group": "afaab3096b157a9b",
        "order": 7,
        "width": "2",
        "height": "1",
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 950,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "4369f6169abacabd",
        "type": "ui_text_input",
        "z": "101718428de70120",
        "name": "",
        "label": "QC height 2:",
        "tooltip": "",
        "group": "afaab3096b157a9b",
        "order": 7,
        "width": "2",
        "height": "1",
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 950,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "79ad882e8a6dcf97",
        "type": "ui_text_input",
        "z": "101718428de70120",
        "name": "",
        "label": "QC height 3:",
        "tooltip": "",
        "group": "afaab3096b157a9b",
        "order": 7,
        "width": "2",
        "height": "1",
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 950,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "3102c66145ad20e4",
        "type": "ui_button",
        "z": "101718428de70120",
        "name": "",
        "group": "f4b50fc6dae783b8",
        "order": 7,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Create sensor {{label}}",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 90,
        "y": 200,
        "wires": [
            [
                "2934c4cac4f2c17e",
                "1084b78c0a9e815d"
            ]
        ]
    },
    {
        "id": "0dbb9c7eef8cb3d4",
        "type": "ui_dropdown",
        "z": "101718428de70120",
        "name": "",
        "label": "Application:",
        "tooltip": "",
        "place": "",
        "group": "f4b50fc6dae783b8",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "FloodNet Test",
                "value": "floodnet-test",
                "type": "str"
            },
            {
                "label": "FloodNet Lab",
                "value": "floodnet-lab",
                "type": "str"
            },
            {
                "label": "FloodNet Live",
                "value": "floodnet-live",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 370,
        "y": 540,
        "wires": [
            [
                "a49e8c77b2264e56"
            ]
        ]
    },
    {
        "id": "da430a9b7a874f15",
        "type": "delay",
        "z": "101718428de70120",
        "name": "",
        "pauseType": "rate",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "3",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 590,
        "y": 640,
        "wires": [
            [
                "b55ed6954feb034d"
            ]
        ]
    },
    {
        "id": "35b7b1db898fbdcd",
        "type": "function",
        "z": "101718428de70120",
        "name": "func",
        "func": "var merged = [].concat.apply([], msg.payload);\nmsg.dev_array = merged;\nflow.set('dev_array', msg.dev_array);\nmsg.app_name = flow.get(\"app_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 700,
        "wires": [
            [
                "bd83d31ea5a6ab88"
            ]
        ]
    },
    {
        "id": "8972b54cf9c1ada4",
        "type": "http request",
        "z": "101718428de70120",
        "name": "dev create",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://eu1.cloud.thethings.network/api/v3/applications/{{{app_id}}}/devices",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 610,
        "y": 200,
        "wires": [
            [
                "1aac4e4668e393a9"
            ]
        ]
    },
    {
        "id": "2934c4cac4f2c17e",
        "type": "credentials",
        "z": "101718428de70120",
        "name": "TTI token store",
        "props": [
            {
                "value": "tti_user",
                "type": "msg"
            },
            {
                "value": "tti_token",
                "type": "msg"
            }
        ],
        "x": 300,
        "y": 200,
        "wires": [
            [
                "11d343eed6225d54"
            ]
        ]
    },
    {
        "id": "11d343eed6225d54",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "\nlet dev_id = flow.get(\"dev_id\");\nlet dev_eui = \"\";\nlet join_eui = \"0000000000000000\";\nlet app_id = flow.get(\"app_name\");\n\n\nfor (let n=0, l=dev_id.length; n<l; n++) \n     {\n\t\tvar hex = Number(dev_id.charCodeAt(n)).toString(16);\n\t\tdev_eui += hex;\n\t }\n\t \nconst genRanHex = size => [...Array(size)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');\n\nlet app_key = genRanHex(32).toUpperCase();\n\nmsg.dev_id = dev_id;\nmsg.dev_eui = dev_eui;\nmsg.join_eui = join_eui;\nmsg.app_id = app_id;\nmsg.app_key = app_key;\n\nlet create_device = {\n   \"end_device\":{\n      \"name\": dev_id,\n      \"description\": dev_id,\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui\n      },\n      \"join_server_address\":\"nam1.cloud.thethings.network\",\n      \"network_server_address\":\"nam1.cloud.thethings.network\",\n      \"application_server_address\":\"nam1.cloud.thethings.network\",\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"join_server_address\",\n         \"network_server_address\",\n         \"application_server_address\"\n      ]\n   }\n}\n\nmsg.payload = create_device;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 200,
        "wires": [
            [
                "8972b54cf9c1ada4"
            ]
        ]
    },
    {
        "id": "dc0d1cf9b769ae5c",
        "type": "change",
        "z": "101718428de70120",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "dev_id",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 700,
        "wires": [
            [
                "eed505ce87c33466"
            ]
        ]
    },
    {
        "id": "1aac4e4668e393a9",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "// let dev_id = flow.get(\"dev_id\");\n// let dev_eui = \"\";\n// let join_eui = \"0000000000000000\";\n// let app_id = \"floodnet-test\";\n\n// for (let n=0, l=dev_id.length; n<l; n++) \n//      {\n// \t\tvar hex = Number(dev_id.charCodeAt(n)).toString(16);\n// \t\tdev_eui += hex;\n// \t }\n\t \n// msg.dev_id = dev_id;\n// msg.dev_eui = dev_eui;\n// msg.join_eui = join_eui;\n// msg.app_id = app_id;\n\nlet dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\n\n\n\nlet register_name_server = {\n   \"end_device\":{\n      \"supports_join\": true,\n      \"supports_class_c\": true,\n    //   \"multicast\": true,\n      \"lorawan_version\": \"MAC_V1_0_3\",\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui,\n         \"application_ids\":{\n            \"application_id\": app_id\n         }\n      },\n      \"frequency_plan_id\":\"US_902_928_FSB_2\",\n      \"lorawan_phy_version\":\"PHY_V1_0_3_REV_A\",\n      \"mac_settings\":{\n         \"class_c_timeout\":\"60s\",\n         \"supports_32_bit_f_cnt\": true\n      },\n      \"version_ids\":{\n          \"band_id\":\"US_902_928\"\n      }\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"supports_join\",\n         \"supports_class_c\",\n        //  \"multicast\",\n         \"lorawan_version\",\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"ids.application_ids.application_id\",\n         \"frequency_plan_id\",\n         \"lorawan_phy_version\",\n         \"mac_settings.class_c_timeout\",\n         \"mac_settings.supports_32_bit_f_cnt\",\n         \"version_ids.band_id\"\n      ]\n   }\n}\n\nmsg.payload = register_name_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 200,
        "wires": [
            [
                "5a1b49e415ee35dc"
            ]
        ]
    },
    {
        "id": "5a1b49e415ee35dc",
        "type": "http request",
        "z": "101718428de70120",
        "name": "name server",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/ns/applications/{{{app_id}}}/devices",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 690,
        "y": 260,
        "wires": [
            [
                "c195ed1d211ff08d"
            ]
        ]
    },
    {
        "id": "c195ed1d211ff08d",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\n\nlet register_application_server = {\n   \"end_device\":{\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui,\n         \"application_ids\":{\n            \"application_id\": app_id\n         }\n      },\n      \"version_ids\":{}\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"ids.application_ids.application_id\",\n         \"version_ids\"\n      ]\n   }\n}\n\nmsg.payload = register_application_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 260,
        "wires": [
            [
                "75b76071b07f2f23"
            ]
        ]
    },
    {
        "id": "75b76071b07f2f23",
        "type": "http request",
        "z": "101718428de70120",
        "name": "app server",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/as/applications/{{{app_id}}}/devices",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 730,
        "y": 320,
        "wires": [
            [
                "cc48325095a80a21"
            ]
        ]
    },
    {
        "id": "4d07ac4996dc1d74",
        "type": "http request",
        "z": "101718428de70120",
        "name": "join server",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/js/applications/{{{app_id}}}/devices",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 770,
        "y": 380,
        "wires": [
            [
                "bcfa2c297dc4e7cf"
            ]
        ]
    },
    {
        "id": "cc48325095a80a21",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\nlet app_key = msg.app_key;\n\nlet register_join_server = {\n   \"end_device\":{\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui,\n         \"application_ids\":{\n            \"application_id\": app_id\n         }\n      },\n      \"network_server_address\":\"nam1.cloud.thethings.network\",\n      \"application_server_address\":\"nam1.cloud.thethings.network\",\n      \"root_keys\":{\n         \"app_key\":{\n            \"key\": app_key\n         }\n      }\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"ids.application_ids.application_id\",\n         \"network_server_address\",\n         \"application_server_address\",\n         \"root_keys.app_key.key\"\n      ]\n   }\n}\n\nmsg.payload = register_join_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 320,
        "wires": [
            [
                "4d07ac4996dc1d74"
            ]
        ]
    },
    {
        "id": "f62b460a0f72b0e5",
        "type": "ui_toast",
        "z": "101718428de70120",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 1350,
        "y": 360,
        "wires": []
    },
    {
        "id": "bcfa2c297dc4e7cf",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "if (msg.statusCode == 200){\n    msg.payload = msg.dev_id + \" created successfully\";\n}\n\n\nlet dev_eui = msg.dev_eui.match(/.{1,2}/g);\nlet dev_eui_str = \"\";\nfor (let n=0, l=dev_eui.length; n<l; n++) {\n\tdev_eui_str += \"0x\" + dev_eui[n] + \", \";\n}\nmsg.dev_eui_str = dev_eui_str.replace(/,\\s*$/, \"\");\n\nlet join_eui = msg.join_eui.match(/.{1,2}/g);\nlet join_eui_str = \"\";\nfor (let n=0, l=join_eui.length; n<l; n++) {\n\tjoin_eui_str += \"0x\" + join_eui[n] + \", \";\n}\nmsg.join_eui_str = join_eui_str.replace(/,\\s*$/, \"\");\n\n\nlet app_key = msg.app_key.match(/.{1,2}/g);\nlet app_key_str = \"\";\nfor (let n=0, l=app_key.length; n<l; n++) {\n\tapp_key_str += \"0x\" + app_key[n] + \", \";\n}\nmsg.app_key_str = app_key_str.replace(/,\\s*$/, \"\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 380,
        "wires": [
            [
                "f62b460a0f72b0e5",
                "95d43463751127ad",
                "a456ce6dc4aef168",
                "08b296cf0165fe4e",
                "d7bc2ad0178a8538",
                "db17c8d1e844f1cd",
                "b3cfbad6b41d273f"
            ]
        ]
    },
    {
        "id": "1b05ea7224dd9ca3",
        "type": "ui_ui_control",
        "z": "101718428de70120",
        "name": "On load",
        "events": "connect",
        "x": 80,
        "y": 240,
        "wires": [
            [
                "acc9f8b02e7db096",
                "bebdf6dcffd9bcaa",
                "2ffd2efe70d8b162",
                "6705821b83fd7f73",
                "84e574eac8693c8f",
                "67ee6098cf942a88"
            ]
        ]
    },
    {
        "id": "acc9f8b02e7db096",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "ttn",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 240,
        "wires": [
            [
                "cf8c1e604a7e8a11"
            ]
        ]
    },
    {
        "id": "bebdf6dcffd9bcaa",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "range",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 300,
        "wires": [
            [
                "74087393325035f7"
            ]
        ]
    },
    {
        "id": "2ffd2efe70d8b162",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "psv",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 360,
        "wires": [
            [
                "0c9700d67847344a"
            ]
        ]
    },
    {
        "id": "6705821b83fd7f73",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "nyu_mk2",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 420,
        "wires": [
            [
                "3ab57096287dda8f"
            ]
        ]
    },
    {
        "id": "84e574eac8693c8f",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "micro",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 480,
        "wires": [
            [
                "c90888da15b9b25a"
            ]
        ]
    },
    {
        "id": "67ee6098cf942a88",
        "type": "change",
        "z": "101718428de70120",
        "name": "set def",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "floodnet-test",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 230,
        "y": 540,
        "wires": [
            [
                "0dbb9c7eef8cb3d4"
            ]
        ]
    },
    {
        "id": "31ce1c7723886059",
        "type": "function",
        "z": "101718428de70120",
        "name": "Set flow vars",
        "func": "flow.set(msg.var_name, msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "a456ce6dc4aef168",
        "type": "switch",
        "z": "101718428de70120",
        "name": "",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "200",
                "vt": "num"
            },
            {
                "t": "neq",
                "v": "200",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 340,
        "wires": [
            [
                "0e9c0fb8036ca69c"
            ],
            [
                "a8538b7782c5fc8c"
            ]
        ]
    },
    {
        "id": "0e9c0fb8036ca69c",
        "type": "function",
        "z": "101718428de70120",
        "name": "",
        "func": "let meas_type = \"\";\n\nswitch (msg.dev_id.substring(0, 2)) {\n  case 'fs':\n    meas_type = \"flood-sensor\";\n    break;\n  case 'ts':\n    meas_type = \"tidal-sensor\";\n    break;\n  case 'rg':\n    meas_type = \"gateway-rain-gauge\";\n    break;\n}\n\nvar tags = {\n            dev_id: msg.dev_id,\n            dev_eui: msg.dev_eui,\n            network: flow.get(\"network\"),\n            sensor_types: flow.get(\"sensor_types\").join(),\n            built_by: flow.get(\"built_by\"),\n            design_ver: flow.get(\"design_ver\"),\n            housing: flow.get(\"housing\"),\n            app_name: flow.get(\"app_name\")\n        };\n\nvar fields = {\n            \"f_cnt\": 0\n        };\n\nmsg.bucket = flow.get(\"app_name\");\n\nmsg.payload = [\n    {\n        measurement: meas_type,\n        fields,\n        tags,\n        timestamp: Date.now()\n    }\n    ];\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 300,
        "wires": [
            [
                "4a4848eba73ecf9c"
            ]
        ]
    },
    {
        "id": "4a4848eba73ecf9c",
        "type": "influxdb batch",
        "z": "101718428de70120",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Sensor data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 1350,
        "y": 220,
        "wires": []
    },
    {
        "id": "e13c2b115ae6c405",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "network",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 240,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "39fc015814128640",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "sensor_types",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 300,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "07c0c2992678b86e",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "built_by",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 360,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "505a67c8f2179f38",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "design_ver",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 420,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "89ab5415ab2c45e1",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "housing",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 480,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "a49e8c77b2264e56",
        "type": "change",
        "z": "101718428de70120",
        "name": "set var",
        "rules": [
            {
                "t": "set",
                "p": "var_name",
                "pt": "msg",
                "to": "app_name",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 540,
        "wires": [
            [
                "31ce1c7723886059"
            ]
        ]
    },
    {
        "id": "08b296cf0165fe4e",
        "type": "ui_text",
        "z": "101718428de70120",
        "group": "a8ccca99870fd736",
        "order": 4,
        "width": "6",
        "height": "2",
        "name": "",
        "label": "App key:",
        "format": "<font size = 2>{{msg.app_key_str}}",
        "layout": "row-left",
        "className": "",
        "x": 1340,
        "y": 520,
        "wires": []
    },
    {
        "id": "d7bc2ad0178a8538",
        "type": "ui_text",
        "z": "101718428de70120",
        "group": "a8ccca99870fd736",
        "order": 2,
        "width": "6",
        "height": "2",
        "name": "",
        "label": "Dev EUI:",
        "format": "<font size = 2>{{msg.dev_eui_str}}",
        "layout": "row-left",
        "className": "",
        "x": 1340,
        "y": 440,
        "wires": []
    },
    {
        "id": "db17c8d1e844f1cd",
        "type": "ui_text",
        "z": "101718428de70120",
        "group": "a8ccca99870fd736",
        "order": 3,
        "width": "6",
        "height": "2",
        "name": "",
        "label": "Join EUI:",
        "format": "<font size = 2>{{msg.join_eui_str}}",
        "layout": "row-left",
        "className": "",
        "x": 1340,
        "y": 480,
        "wires": []
    },
    {
        "id": "b3cfbad6b41d273f",
        "type": "ui_text",
        "z": "101718428de70120",
        "group": "a8ccca99870fd736",
        "order": 1,
        "width": "6",
        "height": "2",
        "name": "",
        "label": "Dev ID:",
        "format": "<font size = 3>{{msg.dev_id}}",
        "layout": "row-left",
        "className": "",
        "x": 1340,
        "y": 400,
        "wires": []
    },
    {
        "id": "a8538b7782c5fc8c",
        "type": "change",
        "z": "101718428de70120",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "dev_eui_str",
                "pt": "msg",
                "to": "",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "join_eui_str",
                "pt": "msg",
                "to": "",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "app_key_str",
                "pt": "msg",
                "to": "",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "dev_id",
                "pt": "msg",
                "to": "Failed to create {{msg.dev_id}}",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 540,
        "wires": [
            [
                "b3cfbad6b41d273f",
                "d7bc2ad0178a8538",
                "db17c8d1e844f1cd",
                "08b296cf0165fe4e"
            ]
        ]
    },
    {
        "id": "1084b78c0a9e815d",
        "type": "change",
        "z": "101718428de70120",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "enabled",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "label",
                "pt": "msg",
                "to": "- creating...",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 180,
        "y": 120,
        "wires": [
            [
                "3102c66145ad20e4"
            ]
        ]
    },
    {
        "id": "eed505ce87c33466",
        "type": "change",
        "z": "101718428de70120",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "enabled",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "label",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1000,
        "y": 140,
        "wires": [
            [
                "3102c66145ad20e4"
            ]
        ]
    },
    {
        "id": "7eea9fd8404f4ea2",
        "type": "link out",
        "z": "101718428de70120",
        "name": "Sensor list populate",
        "mode": "link",
        "links": [
            "e051a6c96ff4fbc1",
            "98541ff72be22b7c",
            "bf6b8afed0865c0d"
        ],
        "x": 645,
        "y": 820,
        "wires": []
    },
    {
        "id": "8dcebf61b9f5f34f",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "if (msg.payload.action == \"connected\"){\n    msg.payload={\n        \"name\": \"Sensor\",\n        \"draggable\": true,\n        \"lat\": 40.692826, \n        \"lon\": -73.987309,\n        \"icon\": \"times\"\n    };\n} else if (msg.payload.action == \"move\"){\n    flow.set('lat', msg.payload.lat);\n    flow.set('lon', msg.payload.lon);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 100,
        "wires": [
            [
                "682ba9db7a18fead",
                "f210f7a55b64d794"
            ]
        ]
    },
    {
        "id": "682ba9db7a18fead",
        "type": "ui_worldmap",
        "z": "767ee0c79d6fcca5",
        "group": "a8bf5499468b4017",
        "order": 1,
        "width": "6",
        "height": "6",
        "name": "",
        "lat": "40.692826",
        "lon": "-73.987309",
        "zoom": "10",
        "layer": "OSMG",
        "cluster": "",
        "maxage": "",
        "usermenu": "hide",
        "layers": "hide",
        "panit": "true",
        "panlock": "false",
        "zoomlock": "false",
        "hiderightclick": "true",
        "coords": "deg",
        "showgrid": "false",
        "allowFileDrop": "false",
        "path": "/map",
        "overlist": "DR,CO,RA,DN,HM",
        "maplist": "OSMG,OSMC,OSMH,EsriC,EsriS,EsriT,EsriO,EsriDG,NatGeo,UKOS,OS45,OS00,OpTop,SW",
        "mapname": "",
        "mapurl": "",
        "mapopt": "",
        "mapwms": false,
        "x": 590,
        "y": 160,
        "wires": []
    },
    {
        "id": "eedde358d540e432",
        "type": "worldmap in",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "path": "/map",
        "events": "connect,disconnect,point,layer,bounds,files,draw,other",
        "x": 390,
        "y": 40,
        "wires": [
            [
                "8dcebf61b9f5f34f"
            ]
        ]
    },
    {
        "id": "e051a6c96ff4fbc1",
        "type": "link in",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "links": [
            "7eea9fd8404f4ea2"
        ],
        "x": 75,
        "y": 220,
        "wires": [
            [
                "35cce625abaadce8"
            ]
        ]
    },
    {
        "id": "4076dcc8436aa9f1",
        "type": "ui_dropdown",
        "z": "767ee0c79d6fcca5",
        "name": "Sensor type",
        "label": "Sensor type:",
        "tooltip": "",
        "place": "Sensor type",
        "group": "803f2d085a7b80f8",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Flood sensor",
                "value": "fs",
                "type": "str"
            },
            {
                "label": "Rain gauge",
                "value": "rg",
                "type": "str"
            },
            {
                "label": "Tidal sensor",
                "value": "ts",
                "type": "str"
            },
            {
                "label": "Old convention",
                "value": "fn",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 370,
        "y": 220,
        "wires": [
            [
                "749b3817a4bc2996"
            ]
        ]
    },
    {
        "id": "749b3817a4bc2996",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "var dev_array = flow.get(\"dev_array\");\n\nvar dev_type = msg.payload;\n\nconst filt_devs = dev_array.filter((dev) => {\n  return dev.includes(dev_type);\n}).sort();\n\nmsg.options = filt_devs;\nmsg.payload = filt_devs[0];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 220,
        "wires": [
            [
                "16d6041297e73d16"
            ]
        ]
    },
    {
        "id": "16d6041297e73d16",
        "type": "ui_dropdown",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Sensor ID:",
        "tooltip": "",
        "place": "Select option",
        "group": "803f2d085a7b80f8",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 670,
        "y": 220,
        "wires": [
            [
                "f8294c4b45b1d46e"
            ]
        ]
    },
    {
        "id": "35cce625abaadce8",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('dev_array', msg.dev_array);\nflow.set('app_name', msg.app_name);\nmsg.payload = \"fs\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 220,
        "wires": [
            [
                "4076dcc8436aa9f1",
                "97a20f37036a27e3",
                "6cf2e5ec9357fbdf",
                "181f5fd9c6c0624c",
                "f7ef4c98b6a25b06",
                "34ad60785a1988c5"
            ]
        ]
    },
    {
        "id": "e6a158a3f5a704e3",
        "type": "ui_button",
        "z": "767ee0c79d6fcca5",
        "name": "Deploy button",
        "group": "803f2d085a7b80f8",
        "order": 7,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Deploy {{payload}}",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 920,
        "y": 320,
        "wires": [
            [
                "8c46d90e84cc9d2e"
            ]
        ]
    },
    {
        "id": "103dd60e2d228ceb",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Deployment notes:",
        "tooltip": "",
        "group": "803f2d085a7b80f8",
        "order": 5,
        "width": "0",
        "height": "0",
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 530,
        "y": 440,
        "wires": [
            [
                "8bbf23cd69bb9085"
            ]
        ]
    },
    {
        "id": "5cc76664eb2e354a",
        "type": "ui_date_picker",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Date deployed:",
        "group": "803f2d085a7b80f8",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": true,
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 520,
        "y": 400,
        "wires": [
            [
                "5b610bdee3c621d6"
            ]
        ]
    },
    {
        "id": "d96313776cbc733c",
        "type": "ui_dropdown",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Sensor mount:",
        "tooltip": "",
        "place": "Select option",
        "group": "803f2d085a7b80f8",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Drive rail",
                "value": "drive_rail",
                "type": "str"
            },
            {
                "label": "Light pole",
                "value": "light_pole",
                "type": "str"
            },
            {
                "label": "Utility pole",
                "value": "utility_pole",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 520,
        "y": 300,
        "wires": [
            [
                "5c0bade66ca30c96"
            ]
        ]
    },
    {
        "id": "7bf8e3b835ea7f08",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Community contact email:",
        "tooltip": "",
        "group": "803f2d085a7b80f8",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "email",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 560,
        "y": 480,
        "wires": [
            [
                "dd138fc967f66dda"
            ]
        ]
    },
    {
        "id": "97a20f37036a27e3",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "msg.payload = new Date();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 400,
        "wires": [
            [
                "5cc76664eb2e354a"
            ]
        ]
    },
    {
        "id": "6cf2e5ec9357fbdf",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "msg.payload = \"drive_rail\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 300,
        "wires": [
            [
                "d96313776cbc733c"
            ]
        ]
    },
    {
        "id": "5832742686e44bc1",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Street number:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1660,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "d65b61fb22a02ffc",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Neighborhood:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1660,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "a1dc98bbd90a310a",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Borough:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1640,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "30e80340276d2dce",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Zipcode:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1640,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "41621814db10d7fd",
        "type": "ui_button",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "group": "a8bf5499468b4017",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Geocode",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 940,
        "y": 100,
        "wires": [
            [
                "081dafca34fef441",
                "10d3d19c0e2e8680"
            ]
        ]
    },
    {
        "id": "87a626e75ed5293a",
        "type": "http request",
        "z": "767ee0c79d6fcca5",
        "name": "Rev geocode",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://maps.googleapis.com/maps/api/geocode/json?latlng={{lat}},{{lon}}&key={{gkey}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "742fd0ca758c426e"
            ]
        ]
    },
    {
        "id": "081dafca34fef441",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "msg.lat = flow.get(\"lat\");\nmsg.lon = flow.get(\"lon\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 140,
        "wires": [
            [
                "9cb52c9249da41a4"
            ]
        ]
    },
    {
        "id": "742fd0ca758c426e",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "let loc_results = msg.payload.results;\n\nfor (let n=0, l=loc_results.length; n<l; n++) {\n    let loc_el = loc_results[n];\n    \n    if (loc_el.types[0] == \"neighborhood\"){\n        msg.sensor_address_neighborhood = loc_el.address_components[0].short_name;\n        flow.set('sensor_address_neighborhood', msg.sensor_address_neighborhood);\n        break;\n    }\n}\n\nlet loc_parts = msg.payload.results[0].address_components;\n\nfor (let n=0, l=loc_parts.length; n<l; n++) {\n    if (loc_parts[n].types[0] == \"street_number\"){\n        msg.sensor_address_street_number = loc_parts[n].short_name;\n        flow.set('sensor_address_street_number', msg.sensor_address_street_number);\n    }\n    else if (loc_parts[n].types[0] == \"route\"){\n        msg.sensor_address_street = loc_parts[n].short_name;\n        flow.set('sensor_address_street', msg.sensor_address_street);\n    }\n    else if (loc_parts[n].types[2] == \"sublocality_level_1\"){\n        msg.sensor_address_borough = loc_parts[n].short_name;\n        flow.set('sensor_address_borough', msg.sensor_address_borough);\n    }\n    else if (loc_parts[n].types[0] == \"administrative_area_level_1\"){\n        msg.sensor_address_state = loc_parts[n].short_name;\n        flow.set('sensor_address_state', msg.sensor_address_state);\n    }\n    else if (loc_parts[n].types[0] == \"postal_code\"){\n        msg.sensor_address_zip = loc_parts[n].short_name;\n        flow.set('sensor_address_zip', msg.sensor_address_zip);\n    }\n\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 320,
        "wires": [
            [
                "6320e19d1a4a80ed",
                "6dbd79d3a8683524",
                "1265cbc62dcb5dd1",
                "d449809f531ab9c0",
                "15f3d7370b8a7cd7",
                "5f0d0bf418bd129a"
            ]
        ]
    },
    {
        "id": "9cb52c9249da41a4",
        "type": "credentials",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "props": [
            {
                "value": "gkey",
                "type": "msg"
            }
        ],
        "x": 1110,
        "y": 200,
        "wires": [
            [
                "87a626e75ed5293a"
            ]
        ]
    },
    {
        "id": "c7ef3659c981d265",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Street name:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1650,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "7353b0e4a46b4f0f",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "State:",
        "tooltip": "",
        "group": "15cc5b5e815472cf",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 1630,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "6320e19d1a4a80ed",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_street_number",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 180,
        "wires": [
            [
                "5832742686e44bc1"
            ]
        ]
    },
    {
        "id": "6dbd79d3a8683524",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_street",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 220,
        "wires": [
            [
                "c7ef3659c981d265"
            ]
        ]
    },
    {
        "id": "1265cbc62dcb5dd1",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_neighborhood",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 260,
        "wires": [
            [
                "d65b61fb22a02ffc"
            ]
        ]
    },
    {
        "id": "d449809f531ab9c0",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_borough",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 300,
        "wires": [
            [
                "a1dc98bbd90a310a"
            ]
        ]
    },
    {
        "id": "15f3d7370b8a7cd7",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_zip",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 340,
        "wires": [
            [
                "30e80340276d2dce"
            ]
        ]
    },
    {
        "id": "5f0d0bf418bd129a",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Set payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sensor_address_state",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1350,
        "y": 380,
        "wires": [
            [
                "7353b0e4a46b4f0f"
            ]
        ]
    },
    {
        "id": "10d3d19c0e2e8680",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1330,
        "y": 120,
        "wires": [
            [
                "5832742686e44bc1",
                "c7ef3659c981d265",
                "d65b61fb22a02ffc",
                "a1dc98bbd90a310a",
                "30e80340276d2dce",
                "7353b0e4a46b4f0f"
            ]
        ]
    },
    {
        "id": "181f5fd9c6c0624c",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Clear text",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 440,
        "wires": [
            [
                "103dd60e2d228ceb"
            ]
        ]
    },
    {
        "id": "f7ef4c98b6a25b06",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Clear text",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 480,
        "wires": [
            [
                "7bf8e3b835ea7f08"
            ]
        ]
    },
    {
        "id": "98541ff72be22b7c",
        "type": "link in",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "links": [
            "7eea9fd8404f4ea2"
        ],
        "x": 1005,
        "y": 20,
        "wires": [
            [
                "10d3d19c0e2e8680"
            ]
        ]
    },
    {
        "id": "f210f7a55b64d794",
        "type": "switch",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "property": "payload.action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "move",
                "vt": "str"
            },
            {
                "t": "cont",
                "v": "connect",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 100,
        "wires": [
            [
                "af1904f96b825f32"
            ],
            [
                "738247b9662c513a"
            ]
        ]
    },
    {
        "id": "738247b9662c513a",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "disable",
        "rules": [
            {
                "t": "set",
                "p": "enabled",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "dev_id",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 160,
        "wires": [
            [
                "41621814db10d7fd",
                "e6a158a3f5a704e3"
            ]
        ]
    },
    {
        "id": "af1904f96b825f32",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "enable",
        "rules": [
            {
                "t": "set",
                "p": "enabled",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "dev_id",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 40,
        "wires": [
            [
                "41621814db10d7fd",
                "e6a158a3f5a704e3"
            ]
        ]
    },
    {
        "id": "8c46d90e84cc9d2e",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "let meas_type = \"\";\nlet dev_id = flow.get(\"dev_id\");\nlet lat = flow.get(\"lat\");\nlet lon = flow.get(\"lon\");\n\nswitch (dev_id.substring(0, 2)) {\n  case 'fs':\n    meas_type = \"flood-sensor\";\n    break;\n  case 'ts':\n    meas_type = \"tidal-sensor\";\n    break;\n  case 'rg':\n    meas_type = \"gateway-rain-gauge\";\n    break;\n}\n\nvar tags = {\n            dev_id: dev_id,\n            lat: lat,\n            lon: lon,\n            sensor_address_street_number: flow.get('sensor_address_street_number'),\n            sensor_address_street: flow.get('sensor_address_street'),\n            sensor_address_neighborhood: flow.get('sensor_address_neighborhood'),\n            sensor_address_borough: flow.get('sensor_address_borough'),\n            sensor_address_state: flow.get('sensor_address_state'),\n            sensor_address_zip: flow.get('sensor_address_zip'),\n            date_deployed: flow.get('date_deployed'),\n            sensor_mount: flow.get('sensor_mount'),\n            community_name: flow.get('community_name'),\n            visit_note: flow.get('visit_note'),\n            deployment_id: flow.get('deployment_id')\n        };\n\nvar fields = {\n            \"f_cnt\": 0\n        };\n\nmsg.bucket = flow.get(\"app_name\");\n\nmsg.payload = [\n    {\n        measurement: meas_type,\n        fields,\n        tags,\n        timestamp: Date.now()\n    }\n    ];\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 400,
        "wires": [
            [
                "fa826cb74f47e2d3",
                "acb8d44b88d09024"
            ]
        ]
    },
    {
        "id": "f8294c4b45b1d46e",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('dev_id', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 220,
        "wires": [
            [
                "e6a158a3f5a704e3"
            ]
        ]
    },
    {
        "id": "5b610bdee3c621d6",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('date_deployed', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "8bbf23cd69bb9085",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('visit_note', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "dd138fc967f66dda",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('community_name', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "5c0bade66ca30c96",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('sensor_mount', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "fa826cb74f47e2d3",
        "type": "influxdb batch",
        "z": "767ee0c79d6fcca5",
        "influxdb": "4b9a03aed4358412",
        "precision": "",
        "retentionPolicy": "",
        "name": "Sensor data insert",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "floodnet",
        "bucket": "floodnet-test",
        "x": 1330,
        "y": 440,
        "wires": []
    },
    {
        "id": "acb8d44b88d09024",
        "type": "debug",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1230,
        "y": 500,
        "wires": []
    },
    {
        "id": "e7ddf6ce3a3fe8be",
        "type": "function-npm",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "const { uniqueNamesGenerator, adjectives, colors, animals } = require('unique-names-generator');\nconst randomName = uniqueNamesGenerator({ dictionaries: [adjectives, colors, animals] });\nmsg.payload = randomName;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 520,
        "wires": [
            [
                "fb8b3d7ad558aea9"
            ]
        ]
    },
    {
        "id": "34ad60785a1988c5",
        "type": "change",
        "z": "767ee0c79d6fcca5",
        "name": "Clear text",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "enabled",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 520,
        "wires": [
            [
                "e7ddf6ce3a3fe8be"
            ]
        ]
    },
    {
        "id": "fb8b3d7ad558aea9",
        "type": "ui_text_input",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "label": "Deployment ID:",
        "tooltip": "",
        "group": "803f2d085a7b80f8",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "topic",
        "sendOnBlur": true,
        "className": "",
        "topicType": "msg",
        "x": 700,
        "y": 520,
        "wires": [
            [
                "5a8b7b032ecaaef7"
            ]
        ]
    },
    {
        "id": "5a8b7b032ecaaef7",
        "type": "function",
        "z": "767ee0c79d6fcca5",
        "name": "",
        "func": "flow.set('deployment_id', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "dc6e7792e2fd268f",
        "type": "comment",
        "z": "767ee0c79d6fcca5",
        "name": "Add app change code here before influx insert",
        "info": "",
        "x": 1110,
        "y": 440,
        "wires": []
    },
    {
        "id": "bf6b8afed0865c0d",
        "type": "link in",
        "z": "e63e21ac547645de",
        "name": "",
        "links": [
            "7eea9fd8404f4ea2"
        ],
        "x": 125,
        "y": 40,
        "wires": [
            [
                "b815601c14e2bded"
            ]
        ]
    },
    {
        "id": "b815601c14e2bded",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "flow.set('dev_array', msg.dev_array);\nflow.set('app_id', msg.app_name);\nmsg.app_id = msg.app_name;\nmsg.payload = \"fs\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 40,
        "wires": [
            [
                "1fe7b77cee96508a"
            ]
        ]
    },
    {
        "id": "1fe7b77cee96508a",
        "type": "ui_dropdown",
        "z": "e63e21ac547645de",
        "name": "Sensor type",
        "label": "Sensor type:",
        "tooltip": "",
        "place": "Sensor type",
        "group": "b0207c7b4d5ca6a1",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "Flood sensor",
                "value": "fs",
                "type": "str"
            },
            {
                "label": "Rain gauge",
                "value": "rg",
                "type": "str"
            },
            {
                "label": "Tidal sensor",
                "value": "ts",
                "type": "str"
            },
            {
                "label": "Old convention",
                "value": "fn",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 420,
        "y": 40,
        "wires": [
            [
                "aef31ddcf80e729c"
            ]
        ]
    },
    {
        "id": "aef31ddcf80e729c",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "var dev_array = flow.get(\"dev_array\");\n\nvar dev_type = msg.payload;\n\nconst filt_devs = dev_array.filter((dev) => {\n  return dev.includes(dev_type);\n}).sort();\n\nmsg.options = filt_devs;\nmsg.payload = filt_devs[0];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 40,
        "wires": [
            [
                "2533fb071d2857c4"
            ]
        ]
    },
    {
        "id": "2533fb071d2857c4",
        "type": "ui_dropdown",
        "z": "e63e21ac547645de",
        "name": "",
        "label": "Sensor ID:",
        "tooltip": "",
        "place": "Select option",
        "group": "b0207c7b4d5ca6a1",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": true,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 720,
        "y": 40,
        "wires": [
            [
                "67bdc6efbb6b1c3d"
            ]
        ]
    },
    {
        "id": "854cb3bda7fca56a",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\n\nlet create_device = {\n   \"end_device\":{\n      \"name\": dev_id,\n      \"description\": dev_id,\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui\n      },\n      \"join_server_address\":\"nam1.cloud.thethings.network\",\n      \"network_server_address\":\"nam1.cloud.thethings.network\",\n      \"application_server_address\":\"nam1.cloud.thethings.network\",\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"join_server_address\",\n         \"network_server_address\",\n         \"application_server_address\"\n      ]\n   }\n}\n\nmsg.payload = create_device;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 280,
        "wires": [
            [
                "c802342255ad2205"
            ]
        ]
    },
    {
        "id": "c802342255ad2205",
        "type": "http request",
        "z": "e63e21ac547645de",
        "name": "dev create",
        "method": "DELETE",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://eu1.cloud.thethings.network/api/v3/applications/{{{app_id}}}/devices/{{{dev_id}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 730,
        "y": 280,
        "wires": [
            [
                "e18589d21b0ec2a7",
                "a38c31443c452419"
            ]
        ]
    },
    {
        "id": "7edbede61f58ffb5",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\n\n\n\nlet register_name_server = {\n   \"end_device\":{\n      \"supports_join\": true,\n      \"supports_class_c\": true,\n    //   \"multicast\": true,\n      \"lorawan_version\": \"MAC_V1_0_3\",\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui,\n         \"application_ids\":{\n            \"application_id\": app_id\n         }\n      },\n      \"frequency_plan_id\":\"US_902_928_FSB_2\",\n      \"lorawan_phy_version\":\"PHY_V1_0_3_REV_A\",\n      \"mac_settings\":{\n         \"class_c_timeout\":\"60s\",\n         \"supports_32_bit_f_cnt\": true\n      },\n      \"version_ids\":{\n          \"band_id\":\"US_902_928\"\n      }\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"supports_join\",\n         \"supports_class_c\",\n        //  \"multicast\",\n         \"lorawan_version\",\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"ids.application_ids.application_id\",\n         \"frequency_plan_id\",\n         \"lorawan_phy_version\",\n         \"mac_settings.class_c_timeout\",\n         \"mac_settings.supports_32_bit_f_cnt\",\n         \"version_ids.band_id\"\n      ]\n   }\n}\n\nmsg.payload = register_name_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 280,
        "wires": [
            [
                "d6fa70a680a45b25"
            ]
        ]
    },
    {
        "id": "d6fa70a680a45b25",
        "type": "http request",
        "z": "e63e21ac547645de",
        "name": "name server",
        "method": "DELETE",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/ns/applications/{{{app_id}}}/devices/{{{dev_id}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 430,
        "y": 280,
        "wires": [
            [
                "854cb3bda7fca56a"
            ]
        ]
    },
    {
        "id": "e064a072a8b695ab",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = msg.dev_eui;\nlet join_eui = msg.join_eui;\nlet app_id = msg.app_id;\n\nlet register_application_server = {\n   \"end_device\":{\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui,\n         \"application_ids\":{\n            \"application_id\": app_id\n         }\n      },\n      \"version_ids\":{}\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"ids.application_ids.application_id\",\n         \"version_ids\"\n      ]\n   }\n}\n\nmsg.payload = register_application_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 220,
        "wires": [
            [
                "777484746c701b38"
            ]
        ]
    },
    {
        "id": "777484746c701b38",
        "type": "http request",
        "z": "e63e21ac547645de",
        "name": "app server",
        "method": "DELETE",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/as/applications/{{{app_id}}}/devices/{{{dev_id}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 750,
        "y": 220,
        "wires": [
            [
                "7edbede61f58ffb5"
            ]
        ]
    },
    {
        "id": "828f10d08edf2e15",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "let dev_id = msg.dev_id;\nlet dev_eui = \"\";\nlet join_eui = \"0000000000000000\";\nlet app_id = msg.app_id;\n\n\nfor (let n=0, l=dev_id.length; n<l; n++) \n     {\n\t\tvar hex = Number(dev_id.charCodeAt(n)).toString(16);\n\t\tdev_eui += hex;\n\t }\n\t \n\nmsg.dev_id = dev_id;\nmsg.dev_eui = dev_eui;\nmsg.join_eui = join_eui;\nmsg.app_id = app_id;\n\nlet register_join_server = {\n   \"end_device\":{\n      \"ids\":{\n         \"device_id\": dev_id,\n         \"dev_eui\": dev_eui,\n         \"join_eui\": join_eui\n      },\n      \"network_server_address\":\"nam1.cloud.thethings.network\",\n      \"application_server_address\":\"nam1.cloud.thethings.network\"\n   },\n   \"field_mask\":{\n      \"paths\":[\n         \"ids.device_id\",\n         \"ids.dev_eui\",\n         \"ids.join_eui\",\n         \"network_server_address\",\n         \"application_server_address\"\n      ]\n   }\n}\n\nmsg.payload = register_join_server;\nmsg.headers = {};\nmsg.headers.Authorization = msg.tti_token;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 220,
        "wires": [
            [
                "f9afd1c877d7f0c6"
            ]
        ]
    },
    {
        "id": "f9afd1c877d7f0c6",
        "type": "http request",
        "z": "e63e21ac547645de",
        "name": "join server",
        "method": "DELETE",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://nam1.cloud.thethings.network/api/v3/js/applications/{{{app_id}}}/devices/{{{dev_id}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "x": 450,
        "y": 220,
        "wires": [
            [
                "e064a072a8b695ab"
            ]
        ]
    },
    {
        "id": "e18589d21b0ec2a7",
        "type": "debug",
        "z": "e63e21ac547645de",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 200,
        "wires": []
    },
    {
        "id": "c44e3c1db185f029",
        "type": "credentials",
        "z": "e63e21ac547645de",
        "name": "TTI token store",
        "props": [
            {
                "value": "tti_user",
                "type": "msg"
            },
            {
                "value": "tti_token",
                "type": "msg"
            }
        ],
        "x": 140,
        "y": 220,
        "wires": [
            [
                "828f10d08edf2e15"
            ]
        ]
    },
    {
        "id": "c90ecd6515714e53",
        "type": "split",
        "z": "e63e21ac547645de",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 450,
        "y": 160,
        "wires": [
            [
                "de475b0d543bb171"
            ]
        ]
    },
    {
        "id": "de475b0d543bb171",
        "type": "change",
        "z": "e63e21ac547645de",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "dev_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 160,
        "wires": [
            [
                "b68d74deccb304eb"
            ]
        ]
    },
    {
        "id": "b68d74deccb304eb",
        "type": "delay",
        "z": "e63e21ac547645de",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 790,
        "y": 160,
        "wires": [
            [
                "c44e3c1db185f029"
            ]
        ]
    },
    {
        "id": "2353fcc875d02a21",
        "type": "ui_button",
        "z": "e63e21ac547645de",
        "name": "",
        "group": "b0207c7b4d5ca6a1",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Delete device(s)",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 160,
        "y": 160,
        "wires": [
            [
                "982e81a10ba32cb9"
            ]
        ]
    },
    {
        "id": "67bdc6efbb6b1c3d",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "flow.set('delete_array', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "982e81a10ba32cb9",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "let delete_array = flow.get(\"delete_array\");\nmsg.payload = delete_array;\nmsg.app_id = flow.get('app_id');\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 160,
        "wires": [
            [
                "c90ecd6515714e53"
            ]
        ]
    },
    {
        "id": "ed41573b498b146d",
        "type": "ui_toast",
        "z": "e63e21ac547645de",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 990,
        "y": 380,
        "wires": []
    },
    {
        "id": "a38c31443c452419",
        "type": "function",
        "z": "e63e21ac547645de",
        "name": "",
        "func": "msg.payload = \"Deleted: \" + msg.dev_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 280,
        "wires": [
            [
                "ed41573b498b146d"
            ]
        ]
    },
    {
        "id": "2d3dafa759849701",
        "type": "debug",
        "z": "41b751a153893032",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 240,
        "wires": []
    },
    {
        "id": "9ca3c022c6a0eb66",
        "type": "exec",
        "z": "41b751a153893032",
        "command": "/usr/local/bin/influx delete --bucket \"{{{payload}}}\" -o floodnet --start '1970-01-01T00:00:00Z' --stop '2025-12-31T23:59:00Z'",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Execute command",
        "x": 400,
        "y": 240,
        "wires": [
            [
                "2d3dafa759849701"
            ],
            [
                "2d3dafa759849701"
            ],
            [
                "2d3dafa759849701"
            ]
        ]
    },
    {
        "id": "662442ec9d407a17",
        "type": "inject",
        "z": "41b751a153893032",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "floodnet-test",
        "payloadType": "str",
        "x": 150,
        "y": 240,
        "wires": [
            [
                "9ca3c022c6a0eb66"
            ]
        ]
    }
]